# Self-Healing System Configuration for Aphrodite Engine
# This file defines the behavior of the automated error detection and issue creation system

system:
  name: "Aphrodite Engine Self-Healing System"
  version: "1.0.0"
  enabled: true
  
# Issue assignment and notification settings
assignments:
  default_assignees: ["dtecho", "drzo"]
  escalation_assignees: ["dtecho", "drzo"]  # For critical issues
  notification_channels:
    - type: "github_issue"
      enabled: true
    - type: "github_comment" 
      enabled: true

# Error detection configuration
error_detection:
  # How often to run automatic detection (in workflow context)
  check_interval: "on_workflow_failure"
  
  # Error categories to monitor
  categories:
    build_failures:
      enabled: true
      severity_mapping:
        cmake_error: "high"
        compilation_error: "high" 
        linking_error: "high"
        dependency_error: "medium"
      file_patterns:
        - "build/**/*error*"
        - "build/**/*Error*"
        - "CMakeError.log"
        - "CMakeOutput.log"
    
    test_failures:
      enabled: true
      severity_mapping:
        segmentation_fault: "critical"
        import_error: "high"
        test_timeout: "medium"
        assertion_failure: "medium"
      file_patterns:
        - ".pytest_cache/v/cache/lastfailed"
        - "core.*"
        - "*.core"
        - "test_*.log"
    
    deep_tree_echo_errors:
      enabled: true
      severity_mapping:
        dtesn_processor_error: "high"
        missing_echo_components: "medium"
        aar_orchestration_error: "high"
        memory_system_error: "critical"
      components:
        - "echo.kern"
        - "echo.self"
        - "echo.dash"
        - "echo.dream"
        - "echo.rkwv"
        - "aar_core"
      file_patterns:
        - "**/*dtesn*.py"
        - "**/*echo*.py"
        - "**/*aar*.py"
    
    deployment_failures:
      enabled: true
      severity_mapping:
        container_build_failure: "high"
        service_start_failure: "critical"
        api_endpoint_failure: "high"
        model_loading_failure: "high"
      file_patterns:
        - "docker/**/*.log"
        - "deployment/**/*.log"
        - "*.deployment.log"
    
    import_errors:
      enabled: true
      severity_mapping:
        core_module_error: "critical"
        optional_module_error: "medium"
        dependency_missing: "high"
      modules_to_test:
        - module: "aphrodite"
          required: true
          severity: "critical"
        - module: "aphrodite.engine"
          required: true
          severity: "critical"
        - module: "aphrodite.endpoints"
          required: true
          severity: "high"
        - module: "aphrodite.endpoints.deep_tree_echo"
          required: false
          severity: "high"

# Issue creation settings
issue_creation:
  # Prevent duplicate issues for same error type within time window
  duplicate_prevention:
    enabled: true
    time_window_hours: 24
    similarity_threshold: 0.8
  
  # Issue templates by error type
  templates:
    build_failure:
      title_template: "ðŸ”´ [BLOCKING] Build System Failure - {timestamp}"
      priority: "high"
      estimated_resolution_time: "2 hours"
    
    test_failure:
      title_template: "ðŸŸ  [BLOCKING] Test Suite Failure - {timestamp}"
      priority: "medium"
      estimated_resolution_time: "4 hours"
    
    critical_error:
      title_template: "ðŸš¨ [CRITICAL] System Critical Error - {timestamp}"
      priority: "critical"
      estimated_resolution_time: "30 minutes"
    
    echo_system_error:
      title_template: "ðŸŒ³ [BLOCKING] Deep Tree Echo System Error - {timestamp}"
      priority: "high"
      estimated_resolution_time: "2 hours"
  
  # Labels to apply to created issues
  labels:
    always_apply:
      - "blocking-error"
      - "self-healing"
      - "auto-generated"
    
    by_severity:
      critical: ["urgent", "p0"]
      high: ["important", "p1"] 
      medium: ["p2"]
      low: ["p3"]
    
    by_component:
      build_system: ["build", "cmake", "compilation"]
      testing: ["tests", "qa"]
      deep_tree_echo: ["echo-system", "dtesn", "aar"]
      deployment: ["deployment", "infrastructure"]

# Recovery and rollback procedures
recovery:
  # Automatic recovery attempts for specific error types
  auto_recovery:
    enabled: true
    max_attempts: 3
    
    procedures:
      build_failure:
        enabled: true
        steps:
          - name: "clean_build_artifacts"
            command: "rm -rf build/ dist/ *.egg-info/"
            timeout: 30
          - name: "clear_ccache"
            command: "ccache -C"
            timeout: 30
          - name: "reinstall_dependencies"
            command: "pip install -r requirements/build.txt"
            timeout: 300
      
      test_failure:
        enabled: true
        steps:
          - name: "clean_python_cache"
            command: "find . -name '*.pyc' -delete && find . -name '__pycache__' -exec rm -rf {} +"
            timeout: 60
          - name: "clear_pytest_cache"
            command: "rm -rf .pytest_cache/"
            timeout: 30
      
      import_error:
        enabled: true
        steps:
          - name: "reinstall_package"
            command: "pip install -e . --force-reinstall"
            timeout: 600

# Monitoring and alerting
monitoring:
  # Health check intervals
  health_checks:
    system_health:
      interval: "daily"
      enabled: true
    
    component_health:
      interval: "on_push"
      enabled: true
    
    dependency_health:
      interval: "weekly"
      enabled: true
  
  # Metrics to track
  metrics:
    error_detection_rate: true
    resolution_time: true
    auto_recovery_success_rate: true
    issue_creation_rate: true
  
  # Alerting thresholds
  thresholds:
    max_open_blocking_issues: 5
    max_critical_issues_age_hours: 4
    max_failed_recovery_attempts: 3

# Integration settings
integrations:
  github:
    enabled: true
    api_version: "v3"
    
  slack:
    enabled: false  # Can be enabled later
    webhook_url: ""
    
  discord:
    enabled: false  # Can be enabled later
    webhook_url: ""

# Development and testing settings
development:
  dry_run_mode: false
  verbose_logging: true
  test_mode_issues: false  # Set to true to create test issues
  
  # Mock error injection for testing
  mock_errors:
    enabled: false
    types: ["build_failure", "test_failure", "import_error"]

# Maintenance and cleanup
maintenance:
  # Auto-close resolved issues
  auto_close_resolved:
    enabled: true
    inactivity_days: 7
    verification_required: true
  
  # Archive old error logs
  log_retention:
    days: 30
    compress_after_days: 7
  
  # Clean up temporary recovery files
  cleanup_temp_files:
    enabled: true
    max_age_hours: 24