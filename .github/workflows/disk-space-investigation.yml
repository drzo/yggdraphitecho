name: ðŸ” Disk Space Investigation

"on":
  workflow_dispatch:
    inputs:
      investigation_level:
        description: 'Level of investigation to perform'
        required: true
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - comprehensive
          - cleanup-only
      include_cleanup:
        description: 'Include actual cleanup (use with caution)'
        required: false
        default: false
        type: boolean
      runner_type:
        description: 'Runner type to investigate'
        required: true
        default: 'ubuntu-latest'
        type: choice
        options:
          - ubuntu-latest
          - ubuntu-22.04
          - ubuntu-20.04
          - windows-latest
          - macos-latest

env:
  # Investigation configuration
  MAX_INVESTIGATION_TIME: 30  # minutes
  REPORT_RETENTION_DAYS: 7

jobs:
  disk-space-investigation:
    name: ðŸ” Investigate Disk Space Usage
    runs-on: ${{ github.event.inputs.runner_type || 'ubuntu-latest' }}
    timeout-minutes: 45
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ” Initial Space Check
        run: |
          echo "=== Initial Disk Space Status ==="
          df -h
          echo ""
          echo "=== Memory Usage ==="
          free -h
          echo ""
          echo "=== Investigation Configuration ==="
          echo "Investigation Level: ${{ github.event.inputs.investigation_level }}"
          echo "Include Cleanup: ${{ github.event.inputs.include_cleanup }}"
          echo "Runner Type: ${{ github.event.inputs.runner_type }}"
          echo "Workflow triggered by: ${{ github.actor }}"

      - name: ðŸ”§ Make Investigation Script Executable
        run: |
          chmod +x scripts/investigate_disk_space.sh
          ls -la scripts/investigate_disk_space.sh

      - name: ðŸ” Quick Investigation
        if: github.event.inputs.investigation_level == 'quick'
        run: |
          echo "=== Quick Disk Space Investigation ==="
          echo "Checking filesystem usage:"
          df -h
          echo ""
          echo "Checking largest directories in root (limited):"
          timeout 60 sudo du -h --max-depth=1 / 2>/dev/null | sort -rh | head -10 || echo "Root analysis timed out"
          echo ""
          echo "Checking workspace usage:"
          if [ -d "/home/runner/work" ]; then
            du -h --max-depth=2 /home/runner/work 2>/dev/null | sort -rh | head -10
          fi

      - name: ðŸ” Standard Investigation
        if: github.event.inputs.investigation_level == 'standard'
        run: |
          echo "=== Running Standard Disk Space Investigation ==="
          ./scripts/investigate_disk_space.sh

      - name: ðŸ” Comprehensive Investigation
        if: github.event.inputs.investigation_level == 'comprehensive'
        timeout-minutes: 30
        run: |
          echo "=== Running Comprehensive Disk Space Investigation ==="
          # Set environment for more detailed analysis
          export MAX_DISPLAY_ITEMS=50
          ./scripts/investigate_disk_space.sh
          
          # Additional comprehensive checks
          echo ""
          echo "=== Additional Comprehensive Analysis ==="
          
          # Check for large files across the system
          echo "Finding largest files (> 100MB):"
          timeout 300 sudo find / -type f -size +100M 2>/dev/null | head -20 || echo "Large file search timed out"
          
          # Detailed package analysis
          echo ""
          echo "Installed package sizes (Ubuntu):"
          if command -v dpkg-query >/dev/null; then
            dpkg-query -Wf '${Installed-Size}\t${Package}\n' | sort -n | tail -20
          fi
          
          # Process analysis
          echo ""
          echo "Current processes using most memory:"
          ps aux --sort=-%mem | head -20

      - name: ðŸ§¹ Cleanup Investigation Only
        if: github.event.inputs.investigation_level == 'cleanup-only'
        run: |
          echo "=== Analyzing Cleanup Opportunities ==="
          
          # Check what could be cleaned
          echo "APT cache size:"
          sudo du -sh /var/cache/apt 2>/dev/null || echo "No APT cache"
          
          echo "Docker usage (if available):"
          if command -v docker >/dev/null; then
            docker system df 2>/dev/null || echo "Docker not running"
          else
            echo "Docker not available"
          fi
          
          echo "Temporary files:"
          sudo find /tmp -type f -size +10M 2>/dev/null | head -10 || echo "No large temp files"
          
          echo "User cache directories:"
          for cache in /root/.cache /home/*/.cache; do
            if [ -d "$cache" ]; then
              sudo du -sh "$cache" 2>/dev/null || true
            fi
          done

      - name: ðŸ§¹ Perform Safe Cleanup
        if: github.event.inputs.include_cleanup == 'true'
        run: |
          echo "=== Performing Safe Cleanup ==="
          
          # Record space before cleanup
          echo "Space before cleanup:"
          df -h /
          
          # Safe cleanup operations
          echo "Cleaning APT cache..."
          sudo apt-get clean || true
          sudo apt-get autoclean || true
          
          echo "Cleaning pip cache..."
          pip cache purge 2>/dev/null || true
          
          echo "Cleaning Docker (if available)..."
          if command -v docker >/dev/null; then
            docker system prune -f 2>/dev/null || true
          fi
          
          echo "Removing temporary build artifacts..."
          # Clean CUDA compilation artifacts
          find /tmp -name "*.fatbin.c" -delete 2>/dev/null || true
          find /tmp -name "*.cudafe*" -delete 2>/dev/null || true
          find /tmp -name "tmpxft_*" -delete 2>/dev/null || true
          
          # Clean old temporary files
          sudo find /tmp -type f -atime +0 -delete 2>/dev/null || true
          
          # Record space after cleanup
          echo "Space after cleanup:"
          df -h /

      - name: ðŸ§¹ Aggressive Cleanup (GitHub Actions Only)
        if: github.event.inputs.include_cleanup == 'true' && contains(github.event.inputs.runner_type, 'ubuntu')
        run: |
          echo "=== Performing Aggressive Cleanup (GitHub Actions Safe) ==="
          
          # Record space before aggressive cleanup
          echo "Space before aggressive cleanup:"
          df -h /
          
          # Remove large pre-installed software that's commonly not needed
          echo "Removing unused pre-installed software..."
          
          # .NET (if not needed)
          sudo rm -rf /usr/share/dotnet 2>/dev/null || true
          
          # Haskell (GHC) 
          sudo rm -rf /opt/ghc 2>/dev/null || true
          
          # Boost libraries (if not needed)
          sudo rm -rf /usr/local/share/boost 2>/dev/null || true
          
          # Agent tools directory (GitHub Actions specific)
          sudo rm -rf "$AGENT_TOOLSDIRECTORY" 2>/dev/null || true
          
          # Android SDK (if not needed)
          sudo rm -rf /usr/local/lib/android 2>/dev/null || true
          
          # Large node modules
          sudo rm -rf /usr/local/lib/node_modules 2>/dev/null || true
          
          # Record space after aggressive cleanup
          echo "Space after aggressive cleanup:"
          df -h /
          
          echo "Cleanup completed successfully!"

      - name: ðŸ“Š Generate Investigation Report
        if: always()
        run: |
          # Create a comprehensive report
          report_file="disk_space_investigation_$(date +%Y%m%d_%H%M%S).md"
          
          cat > "$report_file" << 'EOF'
          # Disk Space Investigation Report
          
          ## Investigation Details
          - **Date**: $(date)
          - **Investigation Level**: ${{ github.event.inputs.investigation_level }}
          - **Cleanup Performed**: ${{ github.event.inputs.include_cleanup }}
          - **Runner Type**: ${{ github.event.inputs.runner_type }}
          - **Triggered By**: ${{ github.actor }}
          - **Workflow Run**: ${{ github.run_id }}
          
          ## Final Disk Usage
          ```
          EOF
          
          df -h >> "$report_file"
          
          cat >> "$report_file" << 'EOF'
          ```
          
          ## Memory Usage
          ```
          EOF
          
          free -h >> "$report_file"
          
          echo '```' >> "$report_file"
          
          # Add investigation script output if it exists
          if [ -f "/tmp/disk_analysis_*/disk_analysis_report.txt" ]; then
            echo "" >> "$report_file"
            echo "## Detailed Analysis Report" >> "$report_file"
            echo '```' >> "$report_file"
            cat /tmp/disk_analysis_*/disk_analysis_report.txt >> "$report_file"
            echo '```' >> "$report_file"
          fi
          
          echo "Generated report: $report_file"

      - name: ðŸ“¤ Upload Investigation Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: disk-space-investigation-report-${{ github.run_number }}
          path: |
            disk_space_investigation_*.md
            /tmp/disk_analysis_*/disk_analysis_report.txt
          retention-days: ${{ env.REPORT_RETENTION_DAYS }}
          if-no-files-found: warn

      - name: ðŸ“‹ Final Summary
        if: always()
        run: |
          echo "=== Disk Space Investigation Summary ==="
          echo "Investigation Level: ${{ github.event.inputs.investigation_level }}"
          echo "Cleanup Performed: ${{ github.event.inputs.include_cleanup }}"
          echo "Final Disk Usage:"
          df -h /
          echo ""
          echo "Investigation artifacts uploaded for download."
          echo "Check the 'Summary' tab for detailed results."
          
          # Add to job summary
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ” Disk Space Investigation Complete
          
          ### Configuration
          - **Investigation Level**: ${{ github.event.inputs.investigation_level }}
          - **Cleanup Performed**: ${{ github.event.inputs.include_cleanup }}
          - **Runner Type**: ${{ github.event.inputs.runner_type }}
          
          ### Final Results
          EOF
          
          echo '```' >> $GITHUB_STEP_SUMMARY
          df -h / >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Investigation reports are available in the workflow artifacts.**" >> $GITHUB_STEP_SUMMARY